library ieee;
use ieee.std_logic_1164.all;
use ieee.numeric_std.all;

entity ADCconv is
    port (cs, wr, rd: out std_logic;
          strobe, intr : in std_logic;
         clk, reset : in std_logic);
end entity;

architecture Behave of ADCconv is
 
component CountDownTimer is
port (Start: in std_logic;
         Count_in: in std_logic_vector(3 downto 0);
         Done: out std_logic;
         clk, reset : in std_logic);
end component CountDownTimer;
   
signal q2, q1, q0, done1: std_logic;
begin
process(strobe,intr, done1, q1,q0,q2, clk)
     -- current state.
     variable q_var : std_logic_vector(2 downto 0);
     -- output
     variable y_var: std_logic_vector(2 downto 0);
     -- next-state
     variable nq_var : std_logic_vector(2 downto 0);
  begin
     q_var(1) := q1; q_var(0) := q0; q_var(2) := q2;
     nq_var := q_var; y_var := "111";
     
     -- compute next-state, output
     case q_var is
       when "000" => --rst
          if (strobe = '1') then 
             nq_var := "001";  
              y_var := "011";
          else 
             nq_var := "000"; --Rst
          end if;
       when "001" =>  
           c: CountDownTimer
           port map(Start=>'1', Count_in=>"0001", clk=>clk, reset=>'1', Done=>done1);   
           if (done1 = '1') then          
             nq_var := "010";
             y_var := "001";
           else 
             nq_var := "001";
           end if;
       when "010" =>
           c: CountDownTimer
           port map(Start=>'1', Count_in=>"0101", clk=>clk, reset=>'1', Done=>done1);  
          if (done1 = '1') then          
             nq_var := "011";
             y_var := "011";
           else 
             nq_var := "010";
           end if;
       when "011" =>
          c: CountDownTimer
          port map(Start=>'1', Count_in=>"1010", clk=>clk, reset=>'1', Done=>done1);  
          if (done1 = '1') then 
             if (intr = '0') then
               nq_var := "100";
               y_var := "010";
             else
               nq_var :="011";
             end if;
          end if;
        when "100" =>
           c: CountDownTimer
           port map(Start=>'1', Count_in=>"0111", clk=>clk, reset=>'1', Done=>done1);  
          if (done1 = '1') then          
             nq_var := "101";
             y_var := "011";
           else 
             nq_var := "100";
           end if; 
        when "101" =>
           c: CountDownTimer
           port map(Start=>'1', Count_in=>"0001", clk=>clk, reset=>'1', Done=>done1);  
          if (done1 = '1') then          
             nq_var := "000";
             y_var := "111";
           else 
             nq_var := "101";
           end if; 
       when others => null;
     end case;
  
     -- y(k)
     cs <= y_var;
     wr <= y_var;
     rd <= y_var;
  
     -- q(k+1) = nq(k)
     if(clk'event and clk = '1') then
          if(r = '1') then
             q2 <= '0'; q1 <= '0'; q0 <= '0';
          else
             q2 <= nq_var (2);
             q1 <= nq_var (1);
             q0 <= nq_var (0);
          end if;
     end if;
  end process;

end Behave;



